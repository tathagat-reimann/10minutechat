<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>10 Minute Chat</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <div class="container mt-5">
    <h1 class="text-center">10 Minute Chat</h1>
    <hr>

    <!-- Create Room Section -->
    <div class="mb-4">
      <h3>Create a Room</h3>
      <button id="createRoomBtn" class="btn btn-primary">Create Room</button>
      <div id="createRoomResult" class="mt-3"></div>
    </div>

    <!-- Join Room Section -->
    <div class="mb-4">
      <h3>Join a Room</h3>
      <form id="joinRoomForm">
        <div class="mb-3">
          <label for="roomIdInput" class="form-label">Room ID</label>
          <input type="text" id="roomIdInput" class="form-control" placeholder="Enter Room ID" required>
        </div>
        <button type="submit" class="btn btn-success">Join Room</button>
      </form>
      <div id="joinRoomResult" class="mt-3"></div>
    </div>

    <!-- Chat Section -->
    <div id="chatSection" class="d-none">
      <h3>Chat Room</h3>
      <p><strong>Your Name:</strong> <span id="chatterName"></span></p>
      <div id="chatMessages" class="border p-3 mb-3" style="height: 300px; overflow-y: auto; background-color: #f8f9fa;"></div>
      <form id="chatForm">
        <div class="input-group">
          <input type="text" id="chatInput" class="form-control" placeholder="Type your message..." required>
          <button type="submit" class="btn btn-primary">Send</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const apiBaseUrl = "http://localhost:8080"; // Update this if your API is hosted elsewhere
    let ws; // WebSocket connection

    // Create Room
    document.getElementById("createRoomBtn").addEventListener("click", async () => {
      try {
        const response = await fetch(`${apiBaseUrl}/room`, { method: "POST" });
        if (!response.ok) throw new Error("Failed to create room");
        const data = await response.json();
        document.getElementById("createRoomResult").innerHTML = `
          <div class="alert alert-success">
            Room created successfully! Room ID: <strong>${data.room_id}</strong>
          </div>
        `;
      } catch (error) {
        document.getElementById("createRoomResult").innerHTML = `
          <div class="alert alert-danger">Error: ${error.message}</div>
        `;
      }
    });

    // Join Room
    document.getElementById("joinRoomForm").addEventListener("submit", (event) => {
      event.preventDefault();
      const roomId = document.getElementById("roomIdInput").value.trim();
      if (!roomId) {
        document.getElementById("joinRoomResult").innerHTML = `
          <div class="alert alert-warning">Please enter a Room ID.</div>
        `;
        return;
      }

      // Create a WebSocket connection
      ws = new WebSocket(`ws://localhost:8080/room/${roomId}/join`);

      ws.onopen = () => {
        document.getElementById("joinRoomResult").innerHTML = `
          <div class="alert alert-success">Successfully joined room: <strong>${roomId}</strong></div>
        `;
        document.getElementById("chatSection").classList.remove("d-none");

        // Request the chatter's name from the server
        ws.send(JSON.stringify({ type: "getName" }));
      };

      ws.onmessage = (event) => {
        const chatMessages = document.getElementById("chatMessages");
        const messageData = JSON.parse(event.data); // Parse the JSON message

        if (messageData.type === "name") {
          // Display the chatter's name
          document.getElementById("chatterName").textContent = messageData.name;
        } else if (messageData.type === "message") {
          // Display chat messages
          const message = document.createElement("div");
          message.innerHTML = `<strong>[${messageData.timestamp}] ${messageData.sender}:</strong> ${messageData.content}`;
          chatMessages.appendChild(message);
          chatMessages.scrollTop = chatMessages.scrollHeight; // Auto-scroll to the latest message
        }
      };

      ws.onerror = (error) => {
        document.getElementById("joinRoomResult").innerHTML = `
          <div class="alert alert-danger">Error: Failed to join room. Please check the Room ID.</div>
        `;
        console.error("WebSocket error:", error);
      };

      ws.onclose = () => {
        console.log("WebSocket connection closed.");
        document.getElementById("chatSection").classList.add("d-none");
      };
    });

    // Send Chat Message
    document.getElementById("chatForm").addEventListener("submit", (event) => {
      event.preventDefault();
      const chatInput = document.getElementById("chatInput");
      const message = chatInput.value.trim();
      if (message && ws && ws.readyState === WebSocket.OPEN) {
        ws.send(message); // Send the message to the server
        chatInput.value = ""; // Clear the input field
      }
    });
  </script>
</body>
</html>